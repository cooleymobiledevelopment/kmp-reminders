# F4.1: Android Basic Notifications

## Objective
Set up NotificationChannel and schedule local notifications for reminders on Android.

## Dependencies
- F1.1 (Reminder model)
- F2.3 (Add/Edit screen - for triggering notification scheduling)

## Requirements
- [ ] NotificationChannel created for reminder notifications
- [ ] AlarmManager for scheduling exact alarms
- [ ] BroadcastReceiver to handle alarm triggers
- [ ] NotificationCompat.Builder for displaying notifications
- [ ] Schedule notification when reminder is created/updated
- [ ] Cancel notification when reminder is deleted/completed
- [ ] Persist scheduled alarms across device reboots
- [ ] Request exact alarm permission (Android 12+)

## Notification Channel Setup

### AndroidApp/src/main/kotlin/.../notification/ReminderNotificationChannel.kt
```kotlin
package com.cooleymd.reminders.notification

import android.app.NotificationChannel
import android.app.NotificationManager
import android.content.Context
import android.os.Build
import androidx.core.app.NotificationManagerCompat

object ReminderNotificationChannel {
    const val CHANNEL_ID = "reminder_notifications"
    const val CHANNEL_NAME = "Reminders"
    const val CHANNEL_DESCRIPTION = "Notifications for scheduled reminders"

    fun createChannel(context: Context) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                CHANNEL_ID,
                CHANNEL_NAME,
                NotificationManager.IMPORTANCE_HIGH
            ).apply {
                description = CHANNEL_DESCRIPTION
                enableVibration(true)
                setShowBadge(true)
            }

            val notificationManager = context.getSystemService(NotificationManager::class.java)
            notificationManager.createNotificationChannel(channel)
        }
    }
}
```

## Notification Scheduler

### AndroidApp/src/main/kotlin/.../notification/ReminderNotificationScheduler.kt
```kotlin
package com.cooleymd.reminders.notification

import android.app.AlarmManager
import android.app.PendingIntent
import android.content.Context
import android.content.Intent
import android.os.Build
import com.cooleymd.reminders.domain.model.Reminder

class ReminderNotificationScheduler(
    private val context: Context
) {
    private val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager

    fun schedule(reminder: Reminder) {
        // Check for exact alarm permission on Android 12+
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            if (!alarmManager.canScheduleExactAlarms()) {
                // Request permission or fall back to inexact alarms
                return
            }
        }

        val intent = Intent(context, ReminderAlarmReceiver::class.java).apply {
            putExtra(EXTRA_REMINDER_ID, reminder.id)
            putExtra(EXTRA_REMINDER_TITLE, reminder.title)
            putExtra(EXTRA_REMINDER_NOTES, reminder.notes)
        }

        val pendingIntent = PendingIntent.getBroadcast(
            context,
            reminder.id.hashCode(),
            intent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        val triggerAtMillis = reminder.scheduledAt.toEpochMilliseconds()

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            alarmManager.setExactAndAllowWhileIdle(
                AlarmManager.RTC_WAKEUP,
                triggerAtMillis,
                pendingIntent
            )
        } else {
            alarmManager.setExact(
                AlarmManager.RTC_WAKEUP,
                triggerAtMillis,
                pendingIntent
            )
        }
    }

    fun cancel(reminderId: String) {
        val intent = Intent(context, ReminderAlarmReceiver::class.java)
        val pendingIntent = PendingIntent.getBroadcast(
            context,
            reminderId.hashCode(),
            intent,
            PendingIntent.FLAG_NO_CREATE or PendingIntent.FLAG_IMMUTABLE
        )

        pendingIntent?.let {
            alarmManager.cancel(it)
            it.cancel()
        }
    }

    companion object {
        const val EXTRA_REMINDER_ID = "reminder_id"
        const val EXTRA_REMINDER_TITLE = "reminder_title"
        const val EXTRA_REMINDER_NOTES = "reminder_notes"
    }
}
```

## Alarm Receiver

### AndroidApp/src/main/kotlin/.../notification/ReminderAlarmReceiver.kt
```kotlin
package com.cooleymd.reminders.notification

import android.Manifest
import android.app.PendingIntent
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Build
import androidx.core.app.ActivityCompat
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import com.cooleymd.reminders.MainActivity
import com.cooleymd.reminders.R

class ReminderAlarmReceiver : BroadcastReceiver() {

    override fun onReceive(context: Context, intent: Intent) {
        val reminderId = intent.getStringExtra(ReminderNotificationScheduler.EXTRA_REMINDER_ID) ?: return
        val title = intent.getStringExtra(ReminderNotificationScheduler.EXTRA_REMINDER_TITLE) ?: "Reminder"
        val notes = intent.getStringExtra(ReminderNotificationScheduler.EXTRA_REMINDER_NOTES)

        showNotification(context, reminderId, title, notes)
    }

    private fun showNotification(
        context: Context,
        reminderId: String,
        title: String,
        notes: String?
    ) {
        // Intent to open the app when notification is tapped
        val contentIntent = Intent(context, MainActivity::class.java).apply {
            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP
            putExtra("reminder_id", reminderId)
        }

        val contentPendingIntent = PendingIntent.getActivity(
            context,
            reminderId.hashCode(),
            contentIntent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        val notification = NotificationCompat.Builder(context, ReminderNotificationChannel.CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification)
            .setContentTitle(title)
            .setContentText(notes ?: "Time for your reminder!")
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setCategory(NotificationCompat.CATEGORY_REMINDER)
            .setAutoCancel(true)
            .setContentIntent(contentPendingIntent)
            .build()

        // Check notification permission for Android 13+
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            if (ActivityCompat.checkSelfPermission(
                    context,
                    Manifest.permission.POST_NOTIFICATIONS
                ) != PackageManager.PERMISSION_GRANTED
            ) {
                return
            }
        }

        NotificationManagerCompat.from(context).notify(
            reminderId.hashCode(),
            notification
        )
    }
}
```

## Boot Receiver (Reschedule after reboot)

### AndroidApp/src/main/kotlin/.../notification/BootCompletedReceiver.kt
```kotlin
package com.cooleymd.reminders.notification

import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import com.cooleymd.reminders.domain.model.ReminderStatus
import com.cooleymd.reminders.domain.repository.ReminderRepository
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.SupervisorJob
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.launch
import kotlinx.datetime.Clock
import org.koin.core.component.KoinComponent
import org.koin.core.component.inject

class BootCompletedReceiver : BroadcastReceiver(), KoinComponent {
    private val reminderRepository: ReminderRepository by inject()
    private val scope = CoroutineScope(SupervisorJob() + Dispatchers.IO)

    override fun onReceive(context: Context, intent: Intent) {
        if (intent.action != Intent.ACTION_BOOT_COMPLETED) return

        val scheduler = ReminderNotificationScheduler(context)
        val now = Clock.System.now()

        scope.launch {
            val reminders = reminderRepository.getAllReminders().first()

            reminders
                .filter { it.status == ReminderStatus.PENDING && it.scheduledAt > now }
                .forEach { reminder ->
                    scheduler.schedule(reminder)
                }
        }
    }
}
```

## AndroidManifest Updates

### AndroidManifest.xml additions
```xml
<manifest ...>
    <!-- Permissions -->
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
    <uses-permission android:name="android.permission.USE_EXACT_ALARM" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <uses-permission android:name="android.permission.VIBRATE" />

    <application ...>
        <!-- Alarm Receiver -->
        <receiver
            android:name=".notification.ReminderAlarmReceiver"
            android:exported="false" />

        <!-- Boot Receiver -->
        <receiver
            android:name=".notification.BootCompletedReceiver"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>
    </application>
</manifest>
```

## Application Class Updates

### AndroidApp/src/main/kotlin/.../RemindersApplication.kt
```kotlin
class RemindersApplication : Application() {
    override fun onCreate() {
        super.onCreate()

        // Initialize Koin
        startKoin {
            androidContext(this@RemindersApplication)
            modules(appModule)
        }

        // Create notification channel
        ReminderNotificationChannel.createChannel(this)
    }
}
```

## Koin Module Updates

### di/AppModule.kt
```kotlin
single { ReminderNotificationScheduler(androidContext()) }
```

## Integration with Use Cases

### Update CreateReminderUseCase
```kotlin
class CreateReminderUseCase(
    private val repository: ReminderRepository,
    private val scheduler: ReminderNotificationScheduler
) {
    suspend operator fun invoke(/* params */) {
        val reminder = // create reminder
        repository.insertReminder(reminder)
        scheduler.schedule(reminder)
    }
}
```

### Update DeleteReminderUseCase
```kotlin
class DeleteReminderUseCase(
    private val repository: ReminderRepository,
    private val scheduler: ReminderNotificationScheduler
) {
    suspend operator fun invoke(id: String) {
        scheduler.cancel(id)
        repository.deleteReminder(id)
    }
}
```

## Notification Icon

Create a notification icon at:
- `composeApp/src/androidMain/res/drawable/ic_notification.xml`

```xml
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24">
    <path
        android:fillColor="#FFFFFF"
        android:pathData="M12,22c1.1,0 2,-0.9 2,-2h-4c0,1.1 0.9,2 2,2zM18,16v-5c0,-3.07 -1.64,-5.64 -4.5,-6.32V4c0,-0.83 -0.67,-1.5 -1.5,-1.5s-1.5,0.67 -1.5,1.5v0.68C7.63,5.36 6,7.92 6,11v5l-2,2v1h16v-1l-2,-2z"/>
</vector>
```

## Verification
```bash
./gradlew :composeApp:installDebug

# Test steps:
# 1. Create a reminder for 1 minute in the future
# 2. Wait for notification to appear
# 3. Tap notification to open app
# 4. Delete a reminder and verify alarm is cancelled
# 5. Reboot device and verify pending reminders get rescheduled
```

## Files to Create/Modify
- `composeApp/src/androidMain/kotlin/.../notification/ReminderNotificationChannel.kt`
- `composeApp/src/androidMain/kotlin/.../notification/ReminderNotificationScheduler.kt`
- `composeApp/src/androidMain/kotlin/.../notification/ReminderAlarmReceiver.kt`
- `composeApp/src/androidMain/kotlin/.../notification/BootCompletedReceiver.kt`
- `composeApp/src/androidMain/res/drawable/ic_notification.xml`
- Update `composeApp/src/androidMain/AndroidManifest.xml`
- Update `composeApp/src/androidMain/kotlin/.../RemindersApplication.kt`
- Update `composeApp/src/commonMain/kotlin/.../di/AppModule.kt`
- Update `CreateReminderUseCase.kt` to schedule notification
- Update `UpdateReminderUseCase.kt` to reschedule notification
- Update `DeleteReminderUseCase.kt` to cancel notification
