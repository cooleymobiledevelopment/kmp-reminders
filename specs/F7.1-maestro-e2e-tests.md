# F7.1: Maestro E2E Tests

## Objective
Set up end-to-end UI testing using Maestro for both Android and iOS platforms.

## Dependencies
- F2.2 (Android Home Screen)
- F2.3 (Android Add/Edit Screen)
- F3.2 (iOS Home Screen)
- F3.3 (iOS Add/Edit Screen)

## Requirements
- [ ] Maestro installed and configured
- [ ] Test directory structure created
- [ ] Core user journey tests written
- [ ] CI integration configured
- [ ] Test data management strategy

## Project Structure

```
e2e/
├── flows/
│   ├── android/
│   │   ├── create_reminder.yaml
│   │   ├── edit_reminder.yaml
│   │   ├── delete_reminder.yaml
│   │   ├── complete_reminder.yaml
│   │   ├── snooze_reminder.yaml
│   │   ├── labels_management.yaml
│   │   └── navigation.yaml
│   ├── ios/
│   │   ├── create_reminder.yaml
│   │   ├── edit_reminder.yaml
│   │   ├── delete_reminder.yaml
│   │   ├── complete_reminder.yaml
│   │   ├── snooze_reminder.yaml
│   │   ├── labels_management.yaml
│   │   └── navigation.yaml
│   └── shared/
│       └── config.yaml
├── scripts/
│   ├── run_android.sh
│   ├── run_ios.sh
│   └── run_all.sh
└── README.md
```

## Installation & Setup

### Prerequisites
```bash
# Install Maestro CLI
curl -Ls "https://get.maestro.mobile.dev" | bash

# Verify installation
maestro --version

# For iOS, ensure Xcode and simulators are available
# For Android, ensure adb is configured
```

### Configuration

#### e2e/flows/shared/config.yaml
```yaml
# Shared configuration for all tests
---
appId:
  android: com.cooleymd.reminders
  ios: com.cooleymd.reminders

# Timeouts (milliseconds)
timeouts:
  default: 5000
  long: 10000
  animation: 1000

# Test data
testData:
  reminder:
    title: "Test Reminder"
    notes: "This is a test reminder created by Maestro"
  label:
    name: "Work"
    color: "#FF5722"
```

## Core Test Flows

### Create Reminder Flow

#### e2e/flows/android/create_reminder.yaml
```yaml
appId: com.cooleymd.reminders
---
# Create Reminder - Android
- launchApp

# Verify we're on home screen
- assertVisible: "Reminders"

# Tap FAB to add new reminder
- tapOn:
    id: "fab_add_reminder"

# Wait for add screen
- assertVisible: "New Reminder"

# Enter reminder title
- tapOn:
    id: "input_title"
- inputText: "Buy groceries"

# Enter notes
- tapOn:
    id: "input_notes"
- inputText: "Milk, eggs, bread"

# Set date/time (tap date picker)
- tapOn:
    id: "btn_date_picker"
- assertVisible: "Select Date"
# Select tomorrow
- tapOn: "OK"

# Set time
- tapOn:
    id: "btn_time_picker"
- assertVisible: "Select Time"
- tapOn: "OK"

# Save reminder
- tapOn:
    id: "btn_save"

# Verify we're back on home and reminder exists
- assertVisible: "Buy groceries"
- assertVisible: "Milk, eggs, bread"
```

#### e2e/flows/ios/create_reminder.yaml
```yaml
appId: com.cooleymd.reminders
---
# Create Reminder - iOS
- launchApp

# Verify we're on home screen
- assertVisible: "Reminders"

# Tap + button to add new reminder
- tapOn:
    accessibilityLabel: "Add Reminder"

# Wait for add screen
- assertVisible: "New Reminder"

# Enter reminder title
- tapOn:
    accessibilityLabel: "Title"
- inputText: "Buy groceries"

# Enter notes
- tapOn:
    accessibilityLabel: "Notes"
- inputText: "Milk, eggs, bread"

# Set date/time
- tapOn:
    accessibilityLabel: "Date"
# iOS date picker interaction
- scroll:
    direction: DOWN
- tapOn: "Done"

# Save reminder
- tapOn: "Save"

# Verify we're back on home and reminder exists
- assertVisible: "Buy groceries"
```

### Edit Reminder Flow

#### e2e/flows/android/edit_reminder.yaml
```yaml
appId: com.cooleymd.reminders
---
# Edit Reminder - Android
- launchApp

# Tap on existing reminder
- tapOn: "Buy groceries"

# Verify edit screen
- assertVisible: "Edit Reminder"

# Update title
- tapOn:
    id: "input_title"
- clearText
- inputText: "Buy groceries and snacks"

# Save changes
- tapOn:
    id: "btn_save"

# Verify updated title on home
- assertVisible: "Buy groceries and snacks"
```

### Delete Reminder Flow

#### e2e/flows/android/delete_reminder.yaml
```yaml
appId: com.cooleymd.reminders
---
# Delete Reminder - Android
- launchApp

# Long press on reminder to show context menu
- longPressOn: "Buy groceries"

# Tap delete option
- tapOn: "Delete"

# Confirm deletion
- tapOn: "Delete"

# Verify reminder is gone
- assertNotVisible: "Buy groceries"
```

#### e2e/flows/ios/delete_reminder.yaml
```yaml
appId: com.cooleymd.reminders
---
# Delete Reminder - iOS
- launchApp

# Swipe to reveal delete action
- swipe:
    direction: LEFT
    from:
      text: "Buy groceries"

# Tap delete
- tapOn: "Delete"

# Verify reminder is gone
- assertNotVisible: "Buy groceries"
```

### Complete Reminder Flow

#### e2e/flows/android/complete_reminder.yaml
```yaml
appId: com.cooleymd.reminders
---
# Complete Reminder - Android
- launchApp

# Tap checkbox to complete
- tapOn:
    id: "checkbox_complete"
    index: 0

# Verify visual feedback (strikethrough or moved to completed)
- assertVisible: "Completed"

# Or verify in completed filter
- tapOn:
    id: "filter_completed"
- assertVisible: "Buy groceries"
```

### Snooze Reminder Flow

#### e2e/flows/android/snooze_reminder.yaml
```yaml
appId: com.cooleymd.reminders
---
# Snooze Reminder - Android
# This test requires a triggered notification

- launchApp

# Tap on triggered reminder
- tapOn: "Buy groceries"

# Tap snooze button
- tapOn:
    id: "btn_snooze"

# Select snooze duration
- tapOn: "1 hour"

# Verify snooze confirmation
- assertVisible: "Snoozed for 1 hour"

# Verify reminder shows snoozed state
- assertVisible: "Snoozed"
```

### Navigation Flow

#### e2e/flows/android/navigation.yaml
```yaml
appId: com.cooleymd.reminders
---
# Navigation - Android
- launchApp

# Verify home tab is selected
- assertVisible: "Reminders"

# Navigate to Labels
- tapOn: "Labels"
- assertVisible: "Labels"

# Navigate to Settings
- tapOn: "Settings"
- assertVisible: "Settings"

# Navigate back to Home
- tapOn: "Home"
- assertVisible: "Reminders"
```

#### e2e/flows/ios/navigation.yaml
```yaml
appId: com.cooleymd.reminders
---
# Navigation - iOS
- launchApp

# Verify home tab is selected
- assertVisible: "Reminders"

# Navigate to Labels tab
- tapOn:
    accessibilityLabel: "Labels"
- assertVisible: "Labels"

# Navigate to Settings tab
- tapOn:
    accessibilityLabel: "Settings"
- assertVisible: "Settings"

# Navigate back to Home tab
- tapOn:
    accessibilityLabel: "Home"
- assertVisible: "Reminders"
```

### Labels Management Flow

#### e2e/flows/android/labels_management.yaml
```yaml
appId: com.cooleymd.reminders
---
# Labels Management - Android
- launchApp

# Navigate to Labels
- tapOn: "Labels"

# Add new label
- tapOn:
    id: "fab_add_label"

# Enter label name
- tapOn:
    id: "input_label_name"
- inputText: "Work"

# Select color
- tapOn:
    id: "color_orange"

# Save label
- tapOn:
    id: "btn_save"

# Verify label created
- assertVisible: "Work"

# Edit label
- tapOn: "Work"
- clearText
- inputText: "Office"
- tapOn:
    id: "btn_save"

# Verify label updated
- assertVisible: "Office"

# Delete label
- longPressOn: "Office"
- tapOn: "Delete"
- tapOn: "Delete"
- assertNotVisible: "Office"
```

## Premium Feature Tests

#### e2e/flows/android/premium_gating.yaml
```yaml
appId: com.cooleymd.reminders
---
# Premium Gating - Android (Free User)
- launchApp

# Create reminders up to free limit
- runFlow: create_reminder.yaml
- repeat:
    times: 9
    commands:
      - tapOn:
          id: "fab_add_reminder"
      - tapOn:
          id: "input_title"
      - inputText: "Reminder ${index}"
      - tapOn:
          id: "btn_save"

# Try to create 11th reminder
- tapOn:
    id: "fab_add_reminder"
- tapOn:
    id: "input_title"
- inputText: "Over limit reminder"
- tapOn:
    id: "btn_save"

# Verify upgrade prompt appears
- assertVisible: "Upgrade to Premium"
- assertVisible: "You've reached the limit of 10 reminders"
```

## Test Scripts

### e2e/scripts/run_android.sh
```bash
#!/bin/bash
set -e

echo "Running Android E2E Tests..."

# Ensure emulator is running
adb devices | grep -q "emulator" || {
    echo "Error: No Android emulator running"
    exit 1
}

# Install the app
./gradlew :composeApp:installDebug

# Run tests
maestro test e2e/flows/android/

echo "Android E2E Tests completed!"
```

### e2e/scripts/run_ios.sh
```bash
#!/bin/bash
set -e

echo "Running iOS E2E Tests..."

# Build and install to simulator
SIMULATOR_ID=$(xcrun simctl list devices | grep "iPhone 15" | grep -v "unavailable" | head -1 | grep -oE '[0-9A-F-]{36}')

if [ -z "$SIMULATOR_ID" ]; then
    echo "Error: No iPhone 15 simulator found"
    exit 1
fi

# Boot simulator if needed
xcrun simctl boot "$SIMULATOR_ID" 2>/dev/null || true

# Build and install
xcodebuild -project iosApp/iosApp.xcodeproj \
    -scheme iosApp \
    -sdk iphonesimulator \
    -destination "id=$SIMULATOR_ID" \
    build

xcrun simctl install "$SIMULATOR_ID" \
    "$(find ~/Library/Developer/Xcode/DerivedData -name 'iosApp.app' -type d | head -1)"

# Run tests
maestro test e2e/flows/ios/

echo "iOS E2E Tests completed!"
```

### e2e/scripts/run_all.sh
```bash
#!/bin/bash
set -e

echo "Running all E2E Tests..."

# Run Android tests
./e2e/scripts/run_android.sh

# Run iOS tests
./e2e/scripts/run_ios.sh

echo "All E2E Tests completed!"
```

## CI Integration

### GitHub Actions Example

#### .github/workflows/e2e-tests.yml
```yaml
name: E2E Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  android-e2e:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Maestro
        run: curl -Ls "https://get.maestro.mobile.dev" | bash

      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          script: |
            ./gradlew :composeApp:installDebug
            ~/.maestro/bin/maestro test e2e/flows/android/

  ios-e2e:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Maestro
        run: curl -Ls "https://get.maestro.mobile.dev" | bash

      - name: Build iOS App
        run: |
          xcodebuild -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            build

      - name: Run iOS E2E Tests
        run: |
          xcrun simctl boot "iPhone 15" || true
          ~/.maestro/bin/maestro test e2e/flows/ios/
```

## Test Data Management

### Resetting App State

For consistent test runs, reset app state before each test:

```yaml
# At the start of each test file
appId: com.cooleymd.reminders
---
- clearState  # Clears app data

# Or for selective clearing, use a setup flow
- runFlow: ../shared/reset_state.yaml
```

### Shared Reset Flow

#### e2e/flows/shared/reset_state.yaml
```yaml
appId: ${appId}
---
- clearState
- launchApp
- stopApp
```

## Accessibility Testing

Include accessibility checks in your flows:

```yaml
# Check that elements have accessibility labels
- assertVisible:
    accessibilityLabel: "Add Reminder"

# Verify focus order (for screen readers)
- assertTrue:
    condition: ${accessibility.isFocused("Title")}
```

## Best Practices

1. **Unique Test IDs**: Add `testTag` (Compose) or `accessibilityIdentifier` (SwiftUI) to UI elements for reliable selection.

2. **Wait for Animations**: Use `waitFor` instead of hard-coded delays:
   ```yaml
   - waitFor:
       visible: "Reminder saved"
       timeout: 5000
   ```

3. **Isolate Tests**: Each test should be independent and not rely on state from other tests.

4. **Screenshots on Failure**: Maestro automatically captures screenshots on failure.

5. **Parameterized Tests**: Use environment variables for test data:
   ```yaml
   - inputText: ${REMINDER_TITLE}
   ```

## Verification

```bash
# Install Maestro
curl -Ls "https://get.maestro.mobile.dev" | bash

# Verify installation
maestro --version

# Run a single test (Android)
maestro test e2e/flows/android/create_reminder.yaml

# Run a single test (iOS)
maestro test e2e/flows/ios/create_reminder.yaml

# Run all Android tests
maestro test e2e/flows/android/

# Run all iOS tests
maestro test e2e/flows/ios/
```

## Files to Create
- `e2e/flows/android/create_reminder.yaml`
- `e2e/flows/android/edit_reminder.yaml`
- `e2e/flows/android/delete_reminder.yaml`
- `e2e/flows/android/complete_reminder.yaml`
- `e2e/flows/android/snooze_reminder.yaml`
- `e2e/flows/android/labels_management.yaml`
- `e2e/flows/android/navigation.yaml`
- `e2e/flows/android/premium_gating.yaml`
- `e2e/flows/ios/create_reminder.yaml`
- `e2e/flows/ios/edit_reminder.yaml`
- `e2e/flows/ios/delete_reminder.yaml`
- `e2e/flows/ios/complete_reminder.yaml`
- `e2e/flows/ios/snooze_reminder.yaml`
- `e2e/flows/ios/labels_management.yaml`
- `e2e/flows/ios/navigation.yaml`
- `e2e/flows/shared/config.yaml`
- `e2e/flows/shared/reset_state.yaml`
- `e2e/scripts/run_android.sh`
- `e2e/scripts/run_ios.sh`
- `e2e/scripts/run_all.sh`
- `e2e/README.md`
- `.github/workflows/e2e-tests.yml` (optional CI integration)
