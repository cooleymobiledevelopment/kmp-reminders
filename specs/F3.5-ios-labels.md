# F3.5: iOS Labels Management

## Objective
Implement labels list screen with CRUD operations and color picker.

## Dependencies
- F3.1 (Navigation)
- F1.3 (LabelRepository via shared KMP module)

## Requirements
- [ ] Labels list screen with all labels
- [ ] Add new label with name and color picker
- [ ] Edit existing label
- [ ] Delete label with confirmation
- [ ] Color picker component
- [ ] Filter reminders by label (optional enhancement)

## Labels ViewModel

### iosApp/Screens/Labels/LabelsViewModel.swift
```swift
import Foundation
import Combine
import Shared

@MainActor
class LabelsViewModel: ObservableObject {
    @Published var labels: [Label] = []
    @Published var isLoading: Bool = true
    @Published var showAddSheet: Bool = false
    @Published var editingLabel: Label? = nil
    @Published var labelToDelete: Label? = nil
    @Published var showDeleteConfirmation: Bool = false

    private let labelRepository: LabelRepository

    init(labelRepository: LabelRepository = KMPBridge.shared.labelRepository) {
        self.labelRepository = labelRepository
        loadLabels()
    }

    func loadLabels() {
        labelRepository.getAllLabels().watch { [weak self] labels in
            guard let self = self, let labels = labels as? [Label] else { return }

            Task { @MainActor in
                self.labels = labels
                self.isLoading = false
            }
        }
    }

    func onAddLabel(name: String, color: String) {
        Task {
            let label = Label(
                id: UUID().uuidString,
                name: name,
                color: color,
                createdAt: Kotlinx_datetimeClock.System.shared.now(),
                updatedAt: Kotlinx_datetimeClock.System.shared.now()
            )
            try? await labelRepository.insertLabel(label: label)
            showAddSheet = false
        }
    }

    func onUpdateLabel(label: Label, name: String, color: String) {
        Task {
            let updated = label.doCopy(
                id: label.id,
                name: name,
                color: color,
                createdAt: label.createdAt,
                updatedAt: Kotlinx_datetimeClock.System.shared.now()
            )
            try? await labelRepository.updateLabel(label: updated)
            editingLabel = nil
        }
    }

    func confirmDelete(label: Label) {
        labelToDelete = label
        showDeleteConfirmation = true
    }

    func executeDelete() {
        guard let label = labelToDelete else { return }
        Task {
            try? await labelRepository.deleteLabel(id: label.id)
            labelToDelete = nil
            showDeleteConfirmation = false
        }
    }

    func cancelDelete() {
        labelToDelete = nil
        showDeleteConfirmation = false
    }
}
```

## Labels Screen

### iosApp/Screens/Labels/LabelsScreen.swift
```swift
import SwiftUI
import Shared

struct LabelsScreen: View {
    @StateObject private var viewModel = LabelsViewModel()

    var body: some View {
        NavigationStack {
            Group {
                if viewModel.isLoading {
                    ProgressView()
                        .frame(maxWidth: .infinity, maxHeight: .infinity)
                } else if viewModel.labels.isEmpty {
                    EmptyStateView(
                        message: "No labels yet",
                        actionLabel: "Add your first label",
                        onAction: { viewModel.showAddSheet = true }
                    )
                } else {
                    List {
                        ForEach(viewModel.labels, id: \.id) { label in
                            LabelRowView(
                                label: label,
                                onTap: { viewModel.editingLabel = label },
                                onDelete: { viewModel.confirmDelete(label: label) }
                            )
                        }
                    }
                    .listStyle(.insetGrouped)
                }
            }
            .navigationTitle("Labels")
            .toolbar {
                ToolbarItem(placement: .primaryAction) {
                    Button {
                        viewModel.showAddSheet = true
                    } label: {
                        Image(systemName: "plus")
                    }
                }
            }
            .sheet(isPresented: $viewModel.showAddSheet) {
                LabelEditorSheet(
                    label: nil,
                    onSave: { name, color in
                        viewModel.onAddLabel(name: name, color: color)
                    },
                    onCancel: { viewModel.showAddSheet = false }
                )
            }
            .sheet(item: $viewModel.editingLabel) { label in
                LabelEditorSheet(
                    label: label,
                    onSave: { name, color in
                        viewModel.onUpdateLabel(label: label, name: name, color: color)
                    },
                    onCancel: { viewModel.editingLabel = nil }
                )
            }
            .alert("Delete Label", isPresented: $viewModel.showDeleteConfirmation) {
                Button("Cancel", role: .cancel) {
                    viewModel.cancelDelete()
                }
                Button("Delete", role: .destructive) {
                    viewModel.executeDelete()
                }
            } message: {
                if let label = viewModel.labelToDelete {
                    Text("Are you sure you want to delete '\(label.name)'? Reminders with this label will keep their data but lose the label association.")
                }
            }
        }
    }
}
```

## Label Row

### iosApp/Screens/Labels/LabelRowView.swift
```swift
import SwiftUI
import Shared

struct LabelRowView: View {
    let label: Label
    let onTap: () -> Void
    let onDelete: () -> Void

    var body: some View {
        HStack(spacing: 12) {
            Circle()
                .fill(Color(hex: label.color) ?? .gray)
                .frame(width: 24, height: 24)

            Text(label.name)
                .font(.body)

            Spacer()
        }
        .contentShape(Rectangle())
        .onTapGesture(perform: onTap)
        .swipeActions(edge: .trailing) {
            Button(role: .destructive, action: onDelete) {
                Label("Delete", systemImage: "trash")
            }
        }
        .contextMenu {
            Button(action: onTap) {
                Label("Edit", systemImage: "pencil")
            }

            Button(role: .destructive, action: onDelete) {
                Label("Delete", systemImage: "trash")
            }
        }
    }
}
```

## Label Editor Sheet

### iosApp/Screens/Labels/LabelEditorSheet.swift
```swift
import SwiftUI
import Shared

struct LabelEditorSheet: View {
    let label: Label?
    let onSave: (String, String) -> Void
    let onCancel: () -> Void

    @State private var name: String
    @State private var selectedColor: String

    init(label: Label?, onSave: @escaping (String, String) -> Void, onCancel: @escaping () -> Void) {
        self.label = label
        self.onSave = onSave
        self.onCancel = onCancel
        _name = State(initialValue: label?.name ?? "")
        _selectedColor = State(initialValue: label?.color ?? "#FF5722")
    }

    var body: some View {
        NavigationStack {
            Form {
                Section {
                    TextField("Label name", text: $name)
                }

                Section("Color") {
                    ColorPickerGrid(
                        selectedColor: $selectedColor
                    )
                }

                Section {
                    HStack {
                        Text("Preview")
                        Spacer()
                        HStack(spacing: 8) {
                            Circle()
                                .fill(Color(hex: selectedColor) ?? .gray)
                                .frame(width: 20, height: 20)
                            Text(name.isEmpty ? "Label Name" : name)
                                .foregroundColor(name.isEmpty ? .secondary : .primary)
                        }
                    }
                }
            }
            .navigationTitle(label == nil ? "New Label" : "Edit Label")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Cancel", action: onCancel)
                }

                ToolbarItem(placement: .confirmationAction) {
                    Button("Save") {
                        onSave(name, selectedColor)
                    }
                    .disabled(name.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty)
                }
            }
        }
        .presentationDetents([.medium])
    }
}
```

## Color Picker Grid

### iosApp/Screens/Labels/ColorPickerGrid.swift
```swift
import SwiftUI

struct ColorPickerGrid: View {
    @Binding var selectedColor: String

    private let colors = [
        "#F44336", "#E91E63", "#9C27B0", "#673AB7",
        "#3F51B5", "#2196F3", "#03A9F4", "#00BCD4",
        "#009688", "#4CAF50", "#8BC34A", "#CDDC39",
        "#FFEB3B", "#FFC107", "#FF9800", "#FF5722"
    ]

    private let columns = [
        GridItem(.adaptive(minimum: 44))
    ]

    var body: some View {
        LazyVGrid(columns: columns, spacing: 12) {
            ForEach(colors, id: \.self) { color in
                Circle()
                    .fill(Color(hex: color) ?? .gray)
                    .frame(width: 40, height: 40)
                    .overlay(
                        Circle()
                            .stroke(selectedColor == color ? Color.primary : Color.clear, lineWidth: 3)
                    )
                    .overlay(
                        Image(systemName: "checkmark")
                            .foregroundColor(.white)
                            .font(.system(size: 16, weight: .bold))
                            .opacity(selectedColor == color ? 1 : 0)
                    )
                    .onTapGesture {
                        selectedColor = color
                    }
            }
        }
        .padding(.vertical, 8)
    }
}
```

## Color Extension

### iosApp/Extensions/ColorExtensions.swift
```swift
import SwiftUI

extension Color {
    init?(hex: String) {
        var hexSanitized = hex.trimmingCharacters(in: .whitespacesAndNewlines)
        hexSanitized = hexSanitized.replacingOccurrences(of: "#", with: "")

        var rgb: UInt64 = 0
        guard Scanner(string: hexSanitized).scanHexInt64(&rgb) else {
            return nil
        }

        let length = hexSanitized.count

        switch length {
        case 6:
            self.init(
                red: Double((rgb & 0xFF0000) >> 16) / 255.0,
                green: Double((rgb & 0x00FF00) >> 8) / 255.0,
                blue: Double(rgb & 0x0000FF) / 255.0
            )
        case 8:
            self.init(
                red: Double((rgb & 0xFF000000) >> 24) / 255.0,
                green: Double((rgb & 0x00FF0000) >> 16) / 255.0,
                blue: Double((rgb & 0x0000FF00) >> 8) / 255.0,
                opacity: Double(rgb & 0x000000FF) / 255.0
            )
        default:
            return nil
        }
    }

    func toHex() -> String? {
        guard let components = UIColor(self).cgColor.components else { return nil }

        let r = Int(components[0] * 255)
        let g = Int(components[1] * 255)
        let b = Int(components[2] * 255)

        return String(format: "#%02X%02X%02X", r, g, b)
    }
}
```

## Make Label Identifiable

### iosApp/Extensions/LabelExtensions.swift
```swift
import Foundation
import Shared

extension Label: Identifiable {
    // Label already has id property from KMP
}
```

## Verification
```bash
# Open iosApp in Xcode and run
# Navigate to Labels tab
# Add new label with color selection
# Edit existing label name and color
# Delete label with confirmation
# Verify label list updates in real-time
```

## Files to Create
- `iosApp/iosApp/Screens/Labels/LabelsViewModel.swift`
- `iosApp/iosApp/Screens/Labels/LabelsScreen.swift`
- `iosApp/iosApp/Screens/Labels/LabelRowView.swift`
- `iosApp/iosApp/Screens/Labels/LabelEditorSheet.swift`
- `iosApp/iosApp/Screens/Labels/ColorPickerGrid.swift`
- `iosApp/iosApp/Extensions/ColorExtensions.swift`
- `iosApp/iosApp/Extensions/LabelExtensions.swift`
- Update `iosApp/iosApp/KMP/KMPBridge.swift` to expose labelRepository
