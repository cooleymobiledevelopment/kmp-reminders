# F4.2: Android Notification Actions

## Objective
Add snooze and complete action buttons to reminder notifications.

## Dependencies
- F4.1 (Basic notifications)
- F1.5 (Snooze/Complete use cases)

## Requirements
- [ ] "Snooze" action button on notification
- [ ] "Complete" action button on notification
- [ ] Snooze duration picker (or default 15 min)
- [ ] Handle actions from BroadcastReceiver
- [ ] Update reminder status after action
- [ ] Dismiss notification after action

## Updated Alarm Receiver with Actions

### notification/ReminderAlarmReceiver.kt
```kotlin
package com.cooleymd.reminders.notification

import android.Manifest
import android.app.PendingIntent
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Build
import androidx.core.app.ActivityCompat
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import com.cooleymd.reminders.MainActivity
import com.cooleymd.reminders.R

class ReminderAlarmReceiver : BroadcastReceiver() {

    override fun onReceive(context: Context, intent: Intent) {
        val reminderId = intent.getStringExtra(EXTRA_REMINDER_ID) ?: return
        val title = intent.getStringExtra(EXTRA_REMINDER_TITLE) ?: "Reminder"
        val notes = intent.getStringExtra(EXTRA_REMINDER_NOTES)

        showNotification(context, reminderId, title, notes)
    }

    private fun showNotification(
        context: Context,
        reminderId: String,
        title: String,
        notes: String?
    ) {
        // Content intent - opens app
        val contentIntent = Intent(context, MainActivity::class.java).apply {
            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP
            putExtra("reminder_id", reminderId)
        }
        val contentPendingIntent = PendingIntent.getActivity(
            context,
            reminderId.hashCode(),
            contentIntent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        // Snooze action
        val snoozeIntent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = ACTION_SNOOZE
            putExtra(EXTRA_REMINDER_ID, reminderId)
            putExtra(EXTRA_REMINDER_TITLE, title)
            putExtra(EXTRA_REMINDER_NOTES, notes)
        }
        val snoozePendingIntent = PendingIntent.getBroadcast(
            context,
            "snooze_$reminderId".hashCode(),
            snoozeIntent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        // Complete action
        val completeIntent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = ACTION_COMPLETE
            putExtra(EXTRA_REMINDER_ID, reminderId)
        }
        val completePendingIntent = PendingIntent.getBroadcast(
            context,
            "complete_$reminderId".hashCode(),
            completeIntent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        // Dismiss action
        val dismissIntent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = ACTION_DISMISS
            putExtra(EXTRA_REMINDER_ID, reminderId)
        }
        val dismissPendingIntent = PendingIntent.getBroadcast(
            context,
            "dismiss_$reminderId".hashCode(),
            dismissIntent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        val notification = NotificationCompat.Builder(context, ReminderNotificationChannel.CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification)
            .setContentTitle(title)
            .setContentText(notes ?: "Time for your reminder!")
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setCategory(NotificationCompat.CATEGORY_REMINDER)
            .setAutoCancel(true)
            .setContentIntent(contentPendingIntent)
            .addAction(
                R.drawable.ic_snooze,
                "Snooze 15m",
                snoozePendingIntent
            )
            .addAction(
                R.drawable.ic_check,
                "Complete",
                completePendingIntent
            )
            .setDeleteIntent(dismissPendingIntent)
            .build()

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            if (ActivityCompat.checkSelfPermission(
                    context,
                    Manifest.permission.POST_NOTIFICATIONS
                ) != PackageManager.PERMISSION_GRANTED
            ) {
                return
            }
        }

        NotificationManagerCompat.from(context).notify(
            reminderId.hashCode(),
            notification
        )
    }

    companion object {
        const val EXTRA_REMINDER_ID = "reminder_id"
        const val EXTRA_REMINDER_TITLE = "reminder_title"
        const val EXTRA_REMINDER_NOTES = "reminder_notes"
        const val ACTION_SNOOZE = "com.cooleymd.reminders.ACTION_SNOOZE"
        const val ACTION_COMPLETE = "com.cooleymd.reminders.ACTION_COMPLETE"
        const val ACTION_DISMISS = "com.cooleymd.reminders.ACTION_DISMISS"
    }
}
```

## Notification Action Receiver

### notification/NotificationActionReceiver.kt
```kotlin
package com.cooleymd.reminders.notification

import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import androidx.core.app.NotificationManagerCompat
import com.cooleymd.reminders.domain.usecase.CompleteReminderUseCase
import com.cooleymd.reminders.domain.usecase.SnoozeReminderUseCase
import com.cooleymd.reminders.domain.usecase.DismissReminderUseCase
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.SupervisorJob
import kotlinx.coroutines.launch
import org.koin.core.component.KoinComponent
import org.koin.core.component.inject
import kotlin.time.Duration.Companion.minutes

class NotificationActionReceiver : BroadcastReceiver(), KoinComponent {
    private val snoozeReminderUseCase: SnoozeReminderUseCase by inject()
    private val completeReminderUseCase: CompleteReminderUseCase by inject()
    private val dismissReminderUseCase: DismissReminderUseCase by inject()
    private val scheduler: ReminderNotificationScheduler by inject()

    private val scope = CoroutineScope(SupervisorJob() + Dispatchers.IO)

    override fun onReceive(context: Context, intent: Intent) {
        val reminderId = intent.getStringExtra(ReminderAlarmReceiver.EXTRA_REMINDER_ID) ?: return

        when (intent.action) {
            ReminderAlarmReceiver.ACTION_SNOOZE -> handleSnooze(context, intent, reminderId)
            ReminderAlarmReceiver.ACTION_COMPLETE -> handleComplete(context, reminderId)
            ReminderAlarmReceiver.ACTION_DISMISS -> handleDismiss(context, reminderId)
        }
    }

    private fun handleSnooze(context: Context, intent: Intent, reminderId: String) {
        val title = intent.getStringExtra(ReminderAlarmReceiver.EXTRA_REMINDER_TITLE)
        val notes = intent.getStringExtra(ReminderAlarmReceiver.EXTRA_REMINDER_NOTES)

        // Dismiss current notification
        NotificationManagerCompat.from(context).cancel(reminderId.hashCode())

        scope.launch {
            // Snooze for 15 minutes by default
            val snoozedReminder = snoozeReminderUseCase(reminderId, 15.minutes)

            // Schedule new notification
            snoozedReminder?.let {
                scheduler.schedule(it)
            }
        }
    }

    private fun handleComplete(context: Context, reminderId: String) {
        // Dismiss notification
        NotificationManagerCompat.from(context).cancel(reminderId.hashCode())

        scope.launch {
            completeReminderUseCase(reminderId)
        }
    }

    private fun handleDismiss(context: Context, reminderId: String) {
        scope.launch {
            dismissReminderUseCase(reminderId)
        }
    }
}
```

## Extended Snooze Options (Optional)

### notification/SnoozeOptionsActivity.kt
```kotlin
package com.cooleymd.reminders.notification

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.core.app.NotificationManagerCompat
import com.cooleymd.reminders.domain.usecase.SnoozeReminderUseCase
import com.cooleymd.reminders.ui.theme.RemindersTheme
import kotlinx.coroutines.launch
import org.koin.android.ext.android.inject
import kotlin.time.Duration
import kotlin.time.Duration.Companion.hours
import kotlin.time.Duration.Companion.minutes

class SnoozeOptionsActivity : ComponentActivity() {
    private val snoozeReminderUseCase: SnoozeReminderUseCase by inject()
    private val scheduler: ReminderNotificationScheduler by inject()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val reminderId = intent.getStringExtra(ReminderAlarmReceiver.EXTRA_REMINDER_ID)
        if (reminderId == null) {
            finish()
            return
        }

        setContent {
            RemindersTheme {
                SnoozeOptionsDialog(
                    onSelect = { duration ->
                        snoozeReminder(reminderId, duration)
                    },
                    onDismiss = { finish() }
                )
            }
        }
    }

    private fun snoozeReminder(reminderId: String, duration: Duration) {
        // Dismiss current notification
        NotificationManagerCompat.from(this).cancel(reminderId.hashCode())

        kotlinx.coroutines.CoroutineScope(kotlinx.coroutines.Dispatchers.IO).launch {
            val snoozedReminder = snoozeReminderUseCase(reminderId, duration)
            snoozedReminder?.let {
                scheduler.schedule(it)
            }
        }

        finish()
    }
}

@Composable
fun SnoozeOptionsDialog(
    onSelect: (Duration) -> Unit,
    onDismiss: () -> Unit
) {
    val options = listOf(
        "5 minutes" to 5.minutes,
        "15 minutes" to 15.minutes,
        "30 minutes" to 30.minutes,
        "1 hour" to 1.hours,
        "2 hours" to 2.hours,
        "Tomorrow morning" to 12.hours // Simplified - could be smarter
    )

    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text("Snooze for...") },
        text = {
            Column {
                options.forEach { (label, duration) ->
                    TextButton(
                        onClick = { onSelect(duration) },
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text(label)
                    }
                }
            }
        },
        confirmButton = {},
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("Cancel")
            }
        }
    )
}
```

## Action Icons

### res/drawable/ic_snooze.xml
```xml
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24">
    <path
        android:fillColor="#FFFFFF"
        android:pathData="M7.88,3.39L6.6,1.86 2,5.71l1.29,1.53 4.59,-3.85zM22,5.72l-4.6,-3.86 -1.29,1.53 4.6,3.86L22,5.72zM12,4c-4.97,0 -9,4.03 -9,9s4.02,9 9,9c4.97,0 9,-4.03 9,-9s-4.03,-9 -9,-9zM12,20c-3.87,0 -7,-3.13 -7,-7s3.13,-7 7,-7 7,3.13 7,7 -3.13,7 -7,7zM9,11h3.63L9,15.2V17h6v-2h-3.63L15,10.8V9H9v2z"/>
</vector>
```

### res/drawable/ic_check.xml
```xml
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24">
    <path
        android:fillColor="#FFFFFF"
        android:pathData="M9,16.17L4.83,12l-1.42,1.41L9,19 21,7l-1.41,-1.41z"/>
</vector>
```

## AndroidManifest Updates

```xml
<application ...>
    <!-- Notification Action Receiver -->
    <receiver
        android:name=".notification.NotificationActionReceiver"
        android:exported="false">
        <intent-filter>
            <action android:name="com.cooleymd.reminders.ACTION_SNOOZE" />
            <action android:name="com.cooleymd.reminders.ACTION_COMPLETE" />
            <action android:name="com.cooleymd.reminders.ACTION_DISMISS" />
        </intent-filter>
    </receiver>

    <!-- Optional: Snooze Options Activity -->
    <activity
        android:name=".notification.SnoozeOptionsActivity"
        android:theme="@style/Theme.Reminders.Dialog"
        android:excludeFromRecents="true"
        android:taskAffinity=""
        android:exported="false" />
</application>
```

## DismissReminderUseCase

### domain/usecase/DismissReminderUseCase.kt
```kotlin
package com.cooleymd.reminders.domain.usecase

import com.cooleymd.reminders.domain.model.ReminderStatus
import com.cooleymd.reminders.domain.repository.ReminderRepository
import kotlinx.datetime.Clock

class DismissReminderUseCase(
    private val repository: ReminderRepository
) {
    suspend operator fun invoke(reminderId: String) {
        val reminder = repository.getReminderById(reminderId) ?: return

        // Mark as dismissed (notification swiped away without action)
        val updated = reminder.copy(
            status = ReminderStatus.DISMISSED,
            updatedAt = Clock.System.now()
        )

        repository.updateReminder(updated)
    }
}
```

## Verification
```bash
./gradlew :composeApp:installDebug

# Test steps:
# 1. Create a reminder for 1 minute in the future
# 2. Wait for notification to appear
# 3. Tap "Snooze 15m" - verify notification dismissed and reappears in 15 min
# 4. Create another reminder, wait for notification
# 5. Tap "Complete" - verify notification dismissed and reminder marked complete
# 6. Swipe notification away - verify reminder marked as dismissed
```

## Files to Create/Modify
- Update `composeApp/src/androidMain/kotlin/.../notification/ReminderAlarmReceiver.kt`
- `composeApp/src/androidMain/kotlin/.../notification/NotificationActionReceiver.kt`
- `composeApp/src/androidMain/kotlin/.../notification/SnoozeOptionsActivity.kt` (optional)
- `composeApp/src/androidMain/res/drawable/ic_snooze.xml`
- `composeApp/src/androidMain/res/drawable/ic_check.xml`
- `composeApp/src/commonMain/kotlin/.../domain/usecase/DismissReminderUseCase.kt`
- Update `composeApp/src/androidMain/AndroidManifest.xml`
- Update `composeApp/src/commonMain/kotlin/.../di/AppModule.kt`
