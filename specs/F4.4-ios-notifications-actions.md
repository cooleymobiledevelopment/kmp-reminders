# F4.4: iOS Notification Actions

## Objective
Add UNNotificationAction for snooze and complete actions on reminder notifications.

## Dependencies
- F4.3 (Basic iOS notifications)
- F1.5 (Snooze/Complete use cases)

## Requirements
- [ ] "Snooze" action button on notification
- [ ] "Complete" action button on notification
- [ ] Default snooze duration (15 minutes)
- [ ] Handle actions from notification delegate
- [ ] Update reminder status after action
- [ ] Reschedule notification after snooze

## Updated Notification Category with Actions

### iosApp/Notifications/ReminderNotificationCategory.swift
```swift
import UserNotifications

struct ReminderNotificationCategory {
    static let identifier = "REMINDER_CATEGORY"

    // Action identifiers
    static let snoozeActionIdentifier = "SNOOZE_ACTION"
    static let snooze5ActionIdentifier = "SNOOZE_5_ACTION"
    static let snooze15ActionIdentifier = "SNOOZE_15_ACTION"
    static let snooze30ActionIdentifier = "SNOOZE_30_ACTION"
    static let snooze60ActionIdentifier = "SNOOZE_60_ACTION"
    static let completeActionIdentifier = "COMPLETE_ACTION"
    static let dismissActionIdentifier = "DISMISS_ACTION"

    static func register() {
        // Quick snooze action (15 min default)
        let snoozeAction = UNNotificationAction(
            identifier: snoozeActionIdentifier,
            title: "Snooze 15m",
            options: []
        )

        // Complete action
        let completeAction = UNNotificationAction(
            identifier: completeActionIdentifier,
            title: "Complete",
            options: [.destructive]
        )

        // Main category with basic actions
        let category = UNNotificationCategory(
            identifier: identifier,
            actions: [snoozeAction, completeAction],
            intentIdentifiers: [],
            options: [.customDismissAction]
        )

        // Optional: Category with snooze submenu (iOS 15+)
        let snoozeMenuCategory = createSnoozeMenuCategory()

        UNUserNotificationCenter.current().setNotificationCategories([category, snoozeMenuCategory])
    }

    private static func createSnoozeMenuCategory() -> UNNotificationCategory {
        let snooze5 = UNNotificationAction(
            identifier: snooze5ActionIdentifier,
            title: "5 minutes",
            options: []
        )

        let snooze15 = UNNotificationAction(
            identifier: snooze15ActionIdentifier,
            title: "15 minutes",
            options: []
        )

        let snooze30 = UNNotificationAction(
            identifier: snooze30ActionIdentifier,
            title: "30 minutes",
            options: []
        )

        let snooze60 = UNNotificationAction(
            identifier: snooze60ActionIdentifier,
            title: "1 hour",
            options: []
        )

        let completeAction = UNNotificationAction(
            identifier: completeActionIdentifier,
            title: "Complete",
            options: [.destructive]
        )

        return UNNotificationCategory(
            identifier: "\(identifier)_EXTENDED",
            actions: [snooze5, snooze15, snooze30, snooze60, completeAction],
            intentIdentifiers: [],
            options: [.customDismissAction]
        )
    }
}
```

## Updated Notification Manager with Action Handling

### iosApp/Notifications/NotificationManager.swift (updated)
```swift
import Foundation
import UserNotifications
import Shared

class NotificationManager: NSObject, ObservableObject {
    static let shared = NotificationManager()

    @Published var isAuthorized: Bool = false

    private let notificationCenter = UNUserNotificationCenter.current()

    // Dependencies for handling actions
    private lazy var snoozeReminderUseCase: SnoozeReminderUseCase = KMPBridge.shared.snoozeReminderUseCase
    private lazy var completeReminderUseCase: CompleteReminderUseCase = KMPBridge.shared.completeReminderUseCase
    private lazy var dismissReminderUseCase: DismissReminderUseCase = KMPBridge.shared.dismissReminderUseCase
    private lazy var reminderRepository: ReminderRepository = KMPBridge.shared.reminderRepository

    override private init() {
        super.init()
        notificationCenter.delegate = self
        checkAuthorizationStatus()
    }

    // ... existing authorization and scheduling methods ...

    // MARK: - Action Handling

    private func handleSnoozeAction(reminderId: String, minutes: Int) {
        Task {
            // Get the reminder
            guard let reminder = try? await reminderRepository.getReminderById(id: reminderId) else {
                return
            }

            // Calculate new scheduled time
            let snoozeDuration = Kotlinx_datetimeDateTimePeriod(minutes: Int32(minutes))

            // Snooze the reminder
            if let snoozedReminder = try? await snoozeReminderUseCase.invoke(id: reminderId, duration: snoozeDuration) {
                // Schedule new notification
                await MainActor.run {
                    self.scheduleNotification(for: snoozedReminder)
                }
            }
        }
    }

    private func handleCompleteAction(reminderId: String) {
        Task {
            try? await completeReminderUseCase.invoke(id: reminderId)
            updateBadgeCount()
        }
    }

    private func handleDismissAction(reminderId: String) {
        Task {
            try? await dismissReminderUseCase.invoke(id: reminderId)
            updateBadgeCount()
        }
    }

    // MARK: - Badge Management

    func updateBadgeCount() {
        Task {
            // Get count of pending reminders that are overdue
            // This is a simplified implementation
            await MainActor.run {
                UNUserNotificationCenter.current().setBadgeCount(0)
            }
        }
    }

    func clearBadge() {
        Task {
            await MainActor.run {
                UNUserNotificationCenter.current().setBadgeCount(0)
            }
        }
    }
}

// MARK: - UNUserNotificationCenterDelegate

extension NotificationManager: UNUserNotificationCenterDelegate {
    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        willPresent notification: UNNotification,
        withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
    ) {
        completionHandler([.banner, .sound, .badge])
    }

    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        didReceive response: UNNotificationResponse,
        withCompletionHandler completionHandler: @escaping () -> Void
    ) {
        let userInfo = response.notification.request.content.userInfo
        guard let reminderId = userInfo["reminderId"] as? String else {
            completionHandler()
            return
        }

        switch response.actionIdentifier {
        case ReminderNotificationCategory.snoozeActionIdentifier,
             ReminderNotificationCategory.snooze15ActionIdentifier:
            handleSnoozeAction(reminderId: reminderId, minutes: 15)

        case ReminderNotificationCategory.snooze5ActionIdentifier:
            handleSnoozeAction(reminderId: reminderId, minutes: 5)

        case ReminderNotificationCategory.snooze30ActionIdentifier:
            handleSnoozeAction(reminderId: reminderId, minutes: 30)

        case ReminderNotificationCategory.snooze60ActionIdentifier:
            handleSnoozeAction(reminderId: reminderId, minutes: 60)

        case ReminderNotificationCategory.completeActionIdentifier:
            handleCompleteAction(reminderId: reminderId)

        case UNNotificationDismissActionIdentifier:
            handleDismissAction(reminderId: reminderId)

        case UNNotificationDefaultActionIdentifier:
            // User tapped notification - navigate to reminder
            NotificationCenter.default.post(
                name: .didTapReminderNotification,
                object: nil,
                userInfo: ["reminderId": reminderId]
            )

        default:
            break
        }

        completionHandler()
    }
}
```

## DismissReminderUseCase for iOS

### Update KMPBridge.swift to expose DismissReminderUseCase
```swift
extension KMPBridge {
    var dismissReminderUseCase: DismissReminderUseCase {
        KoinHelper.shared.getDismissReminderUseCase()
    }
}
```

## Haptic Feedback on Action

### iosApp/Notifications/NotificationFeedback.swift
```swift
import UIKit

struct NotificationFeedback {
    static func actionCompleted() {
        let generator = UINotificationFeedbackGenerator()
        generator.notificationOccurred(.success)
    }

    static func actionSnoozed() {
        let generator = UIImpactFeedbackGenerator(style: .medium)
        generator.impactOccurred()
    }
}
```

## Updated Scheduling with Category

### Update scheduleNotification in NotificationManager.swift
```swift
func scheduleNotification(for reminder: Reminder) {
    cancelNotification(for: reminder.id)

    let content = UNMutableNotificationContent()
    content.title = reminder.title
    content.body = reminder.notes ?? "Time for your reminder!"
    content.sound = .default
    content.badge = 1
    content.userInfo = ["reminderId": reminder.id]

    // Use the category with actions
    content.categoryIdentifier = ReminderNotificationCategory.identifier

    // For more snooze options, use extended category:
    // content.categoryIdentifier = "\(ReminderNotificationCategory.identifier)_EXTENDED"

    let triggerDate = Date(timeIntervalSince1970: TimeInterval(reminder.scheduledAt.epochSeconds))
    guard triggerDate > Date() else { return }

    let components = Calendar.current.dateComponents(
        [.year, .month, .day, .hour, .minute, .second],
        from: triggerDate
    )

    let trigger = UNCalendarNotificationTrigger(
        dateMatching: components,
        repeats: false
    )

    let request = UNNotificationRequest(
        identifier: reminder.id,
        content: content,
        trigger: trigger
    )

    notificationCenter.add(request) { error in
        if let error = error {
            print("Failed to schedule notification: \(error)")
        }
    }
}
```

## Notification Content Extension (Optional - Rich Notifications)

### Create Notification Content Extension target in Xcode
If you want custom UI in the expanded notification:

1. File > New > Target > Notification Content Extension
2. Name it "ReminderNotificationContent"

### NotificationViewController.swift
```swift
import UIKit
import UserNotifications
import UserNotificationsUI

class NotificationViewController: UIViewController, UNNotificationContentExtension {

    @IBOutlet weak var titleLabel: UILabel!
    @IBOutlet weak var bodyLabel: UILabel!
    @IBOutlet weak var timeLabel: UILabel!

    override func viewDidLoad() {
        super.viewDidLoad()
        // Custom setup
    }

    func didReceive(_ notification: UNNotification) {
        let content = notification.request.content
        titleLabel.text = content.title
        bodyLabel.text = content.body

        // Format time
        let formatter = DateFormatter()
        formatter.dateFormat = "h:mm a"
        timeLabel.text = formatter.string(from: Date())
    }

    func didReceive(
        _ response: UNNotificationResponse,
        completionHandler completion: @escaping (UNNotificationContentExtensionResponseOption) -> Void
    ) {
        // Handle inline actions if needed
        completion(.dismissAndForwardAction)
    }
}
```

## Verification
```bash
# Open iosApp in Xcode and run

# Test steps:
# 1. Create a reminder for 1 minute in the future
# 2. Wait for notification to appear
# 3. Long-press notification to see action buttons
# 4. Tap "Snooze 15m" - verify notification reappears in 15 minutes
# 5. Create another reminder, wait for notification
# 6. Tap "Complete" - verify reminder marked as complete in app
# 7. Swipe notification away - verify reminder status updates
# 8. Test actions work when app is closed/background
```

## Files to Create/Modify
- Update `iosApp/iosApp/Notifications/ReminderNotificationCategory.swift`
- Update `iosApp/iosApp/Notifications/NotificationManager.swift`
- `iosApp/iosApp/Notifications/NotificationFeedback.swift`
- Update `iosApp/iosApp/KMP/KMPBridge.swift` for dismissReminderUseCase
- Optional: Create Notification Content Extension target for rich UI
