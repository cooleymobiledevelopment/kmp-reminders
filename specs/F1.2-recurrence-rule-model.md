# F1.2: Recurrence Rule Model

## Objective
Create the RecurrenceRule model for recurring reminders with calculation logic.

## Dependencies
- F1.1 (Reminder model)

## Requirements
- [ ] `RecurrenceRule` data class with frequency, interval, day patterns
- [ ] JSON serialization for storage in SQLDelight TEXT field
- [ ] `calculateNextOccurrence()` function
- [ ] Support patterns: daily, weekly, monthly, yearly, every N days
- [ ] End conditions: never, after N occurrences, until date
- [ ] Comprehensive unit tests for recurrence calculation

## Domain Model

### domain/model/RecurrenceRule.kt
```kotlin
package com.cooleymd.reminders.domain.model

import kotlinx.datetime.DayOfWeek
import kotlinx.datetime.LocalDate
import kotlinx.serialization.Serializable

@Serializable
data class RecurrenceRule(
    val frequency: Frequency,
    val interval: Int = 1, // every N frequency units
    val daysOfWeek: Set<DayOfWeek>? = null, // for weekly
    val dayOfMonth: Int? = null, // for monthly (1-31)
    val weekOfMonth: Int? = null, // for monthly by weekday (1-5)
    val endCondition: EndCondition = EndCondition.Never
)

@Serializable
enum class Frequency {
    HOURLY, DAILY, WEEKLY, MONTHLY, YEARLY
}

@Serializable
sealed class EndCondition {
    @Serializable
    object Never : EndCondition()

    @Serializable
    data class AfterCount(val count: Int) : EndCondition()

    @Serializable
    data class UntilDate(val date: LocalDate) : EndCondition()
}
```

## Recurrence Calculator

### domain/usecase/RecurrenceCalculator.kt
```kotlin
package com.cooleymd.reminders.domain.usecase

import com.cooleymd.reminders.domain.model.*
import kotlinx.datetime.*

class RecurrenceCalculator {

    /**
     * Calculate the next occurrence after the given date.
     * Returns null if the recurrence has ended.
     */
    fun calculateNextOccurrence(
        rule: RecurrenceRule,
        after: Instant,
        completionCount: Int = 0,
        timeZone: TimeZone = TimeZone.currentSystemDefault()
    ): Instant? {
        // Check end condition
        when (val end = rule.endCondition) {
            is EndCondition.Never -> { /* continue */ }
            is EndCondition.AfterCount -> {
                if (completionCount >= end.count) return null
            }
            is EndCondition.UntilDate -> {
                val afterDate = after.toLocalDateTime(timeZone).date
                if (afterDate > end.date) return null
            }
        }

        return when (rule.frequency) {
            Frequency.HOURLY -> calculateHourly(after, rule.interval, timeZone)
            Frequency.DAILY -> calculateDaily(after, rule.interval, timeZone)
            Frequency.WEEKLY -> calculateWeekly(after, rule, timeZone)
            Frequency.MONTHLY -> calculateMonthly(after, rule, timeZone)
            Frequency.YEARLY -> calculateYearly(after, rule.interval, timeZone)
        }
    }

    private fun calculateDaily(after: Instant, interval: Int, tz: TimeZone): Instant {
        val dt = after.toLocalDateTime(tz)
        val nextDate = dt.date.plus(interval, DateTimeUnit.DAY)
        return LocalDateTime(nextDate, dt.time).toInstant(tz)
    }

    private fun calculateWeekly(after: Instant, rule: RecurrenceRule, tz: TimeZone): Instant {
        // If daysOfWeek specified, find next matching day
        // Otherwise, same day next week * interval
    }

    // ... more calculation methods
}
```

## JSON Serialization

The RecurrenceRule will be stored as JSON text in the Reminder's `recurrenceRule` column.

```kotlin
// Serialize
val json = Json.encodeToString(RecurrenceRule.serializer(), rule)

// Deserialize
val rule = Json.decodeFromString(RecurrenceRule.serializer(), json)
```

## Tests

### commonTest/kotlin/.../RecurrenceCalculatorTest.kt

Test cases:
- Daily every 1 day
- Daily every 3 days
- Weekly on specific days (Mon, Wed, Fri)
- Monthly on 15th
- Monthly on 2nd Tuesday
- Yearly
- End after 5 occurrences
- End on specific date
- Edge cases: month end, leap years

## Verification
```bash
./gradlew build
./gradlew :composeApp:testDebugUnitTest --tests "*RecurrenceCalculator*"
```

## Files to Create
- `composeApp/src/commonMain/kotlin/.../domain/model/RecurrenceRule.kt`
- `composeApp/src/commonMain/kotlin/.../domain/usecase/RecurrenceCalculator.kt`
- `composeApp/src/commonTest/kotlin/.../RecurrenceCalculatorTest.kt`
