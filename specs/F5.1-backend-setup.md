# F5.1: Backend Setup - Ktor Server with PostgreSQL

## Objective
Set up a Ktor backend server with PostgreSQL database using Docker for local development.

## Dependencies
- None (standalone backend)

## Requirements
- [ ] Ktor server project created
- [ ] PostgreSQL database with Docker Compose
- [ ] Exposed ORM configured
- [ ] Database migrations setup
- [ ] Health check endpoint
- [ ] Basic project structure (routes, services, repositories)
- [ ] Environment configuration

## Project Structure

```
backend/
├── src/
│   └── main/
│       ├── kotlin/
│       │   └── com/cooleymd/reminders/
│       │       ├── Application.kt
│       │       ├── plugins/
│       │       │   ├── Routing.kt
│       │       │   ├── Serialization.kt
│       │       │   ├── Security.kt
│       │       │   └── Database.kt
│       │       ├── routes/
│       │       │   ├── HealthRoutes.kt
│       │       │   ├── AuthRoutes.kt
│       │       │   └── ReminderRoutes.kt
│       │       ├── data/
│       │       │   ├── tables/
│       │       │   │   ├── UsersTable.kt
│       │       │   │   ├── RemindersTable.kt
│       │       │   │   └── LabelsTable.kt
│       │       │   └── repositories/
│       │       │       ├── UserRepository.kt
│       │       │       ├── ReminderRepository.kt
│       │       │       └── LabelRepository.kt
│       │       ├── domain/
│       │       │   ├── models/
│       │       │   └── services/
│       │       └── util/
│       └── resources/
│           ├── application.conf
│           └── logback.xml
├── build.gradle.kts
├── settings.gradle.kts
├── docker-compose.yml
├── Dockerfile
└── .env.example
```

## build.gradle.kts

```kotlin
plugins {
    kotlin("jvm") version "1.9.22"
    kotlin("plugin.serialization") version "1.9.22"
    id("io.ktor.plugin") version "2.3.7"
}

group = "com.cooleymd.reminders"
version = "0.0.1"

application {
    mainClass.set("com.cooleymd.reminders.ApplicationKt")
}

repositories {
    mavenCentral()
}

dependencies {
    // Ktor Server
    implementation("io.ktor:ktor-server-core-jvm")
    implementation("io.ktor:ktor-server-netty-jvm")
    implementation("io.ktor:ktor-server-content-negotiation-jvm")
    implementation("io.ktor:ktor-serialization-kotlinx-json-jvm")
    implementation("io.ktor:ktor-server-auth-jvm")
    implementation("io.ktor:ktor-server-auth-jwt-jvm")
    implementation("io.ktor:ktor-server-cors-jvm")
    implementation("io.ktor:ktor-server-status-pages-jvm")
    implementation("io.ktor:ktor-server-call-logging-jvm")

    // Database
    implementation("org.jetbrains.exposed:exposed-core:0.46.0")
    implementation("org.jetbrains.exposed:exposed-dao:0.46.0")
    implementation("org.jetbrains.exposed:exposed-jdbc:0.46.0")
    implementation("org.jetbrains.exposed:exposed-kotlin-datetime:0.46.0")
    implementation("org.postgresql:postgresql:42.7.1")
    implementation("com.zaxxer:HikariCP:5.1.0")

    // Password hashing
    implementation("org.mindrot:jbcrypt:0.4")

    // Logging
    implementation("ch.qos.logback:logback-classic:1.4.14")

    // Testing
    testImplementation("io.ktor:ktor-server-tests-jvm")
    testImplementation("org.jetbrains.kotlin:kotlin-test-junit")
}
```

## Docker Compose

### docker-compose.yml
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: reminders-db
    environment:
      POSTGRES_USER: ${DB_USER:-reminders}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-reminders_secret}
      POSTGRES_DB: ${DB_NAME:-reminders}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U reminders"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build: .
    container_name: reminders-backend
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DB_URL=jdbc:postgresql://postgres:5432/reminders
      - DB_USER=reminders
      - DB_PASSWORD=reminders_secret
      - JWT_SECRET=your-super-secret-jwt-key-change-in-production
      - JWT_ISSUER=reminders-api
      - JWT_AUDIENCE=reminders-app
    ports:
      - "8080:8080"

volumes:
  postgres_data:
```

## Application Configuration

### resources/application.conf
```hocon
ktor {
    deployment {
        port = 8080
        port = ${?PORT}
    }
    application {
        modules = [ com.cooleymd.reminders.ApplicationKt.module ]
    }
}

database {
    url = "jdbc:postgresql://localhost:5432/reminders"
    url = ${?DB_URL}
    user = "reminders"
    user = ${?DB_USER}
    password = "reminders_secret"
    password = ${?DB_PASSWORD}
    maxPoolSize = 10
}

jwt {
    secret = "your-super-secret-jwt-key-change-in-production"
    secret = ${?JWT_SECRET}
    issuer = "reminders-api"
    issuer = ${?JWT_ISSUER}
    audience = "reminders-app"
    audience = ${?JWT_AUDIENCE}
    realm = "Reminders API"
    expirationMinutes = 60
    refreshExpirationDays = 30
}
```

## Main Application

### Application.kt
```kotlin
package com.cooleymd.reminders

import com.cooleymd.reminders.plugins.*
import io.ktor.server.application.*
import io.ktor.server.engine.*
import io.ktor.server.netty.*

fun main() {
    embeddedServer(Netty, port = 8080, host = "0.0.0.0", module = Application::module)
        .start(wait = true)
}

fun Application.module() {
    configureDatabase()
    configureSerialization()
    configureSecurity()
    configureRouting()
}
```

## Database Plugin

### plugins/Database.kt
```kotlin
package com.cooleymd.reminders.plugins

import com.cooleymd.reminders.data.tables.LabelsTable
import com.cooleymd.reminders.data.tables.RemindersTable
import com.cooleymd.reminders.data.tables.UsersTable
import com.zaxxer.hikari.HikariConfig
import com.zaxxer.hikari.HikariDataSource
import io.ktor.server.application.*
import org.jetbrains.exposed.sql.Database
import org.jetbrains.exposed.sql.SchemaUtils
import org.jetbrains.exposed.sql.transactions.transaction

fun Application.configureDatabase() {
    val config = environment.config

    val hikariConfig = HikariConfig().apply {
        jdbcUrl = config.property("database.url").getString()
        username = config.property("database.user").getString()
        password = config.property("database.password").getString()
        driverClassName = "org.postgresql.Driver"
        maximumPoolSize = config.propertyOrNull("database.maxPoolSize")?.getString()?.toInt() ?: 10
        isAutoCommit = false
        transactionIsolation = "TRANSACTION_REPEATABLE_READ"
    }

    val dataSource = HikariDataSource(hikariConfig)
    Database.connect(dataSource)

    // Create tables
    transaction {
        SchemaUtils.createMissingTablesAndColumns(
            UsersTable,
            LabelsTable,
            RemindersTable
        )
    }

    log.info("Database connected successfully")
}
```

## Database Tables

### data/tables/UsersTable.kt
```kotlin
package com.cooleymd.reminders.data.tables

import org.jetbrains.exposed.sql.Table
import org.jetbrains.exposed.sql.kotlin.datetime.timestamp

object UsersTable : Table("users") {
    val id = uuid("id")
    val email = varchar("email", 255).uniqueIndex()
    val passwordHash = varchar("password_hash", 255)
    val displayName = varchar("display_name", 255).nullable()
    val createdAt = timestamp("created_at")
    val updatedAt = timestamp("updated_at")

    override val primaryKey = PrimaryKey(id)
}
```

### data/tables/RemindersTable.kt
```kotlin
package com.cooleymd.reminders.data.tables

import org.jetbrains.exposed.sql.Table
import org.jetbrains.exposed.sql.kotlin.datetime.timestamp

object RemindersTable : Table("reminders") {
    val id = uuid("id")
    val userId = uuid("user_id").references(UsersTable.id)
    val title = varchar("title", 500)
    val notes = text("notes").nullable()
    val scheduledAt = timestamp("scheduled_at")
    val recurrenceRule = text("recurrence_rule").nullable() // JSON
    val status = varchar("status", 50)
    val snoozedUntil = timestamp("snoozed_until").nullable()
    val completedAt = timestamp("completed_at").nullable()
    val labelId = uuid("label_id").references(LabelsTable.id).nullable()
    val priority = varchar("priority", 20)
    val createdAt = timestamp("created_at")
    val updatedAt = timestamp("updated_at")
    val deletedAt = timestamp("deleted_at").nullable() // Soft delete

    override val primaryKey = PrimaryKey(id)
}
```

### data/tables/LabelsTable.kt
```kotlin
package com.cooleymd.reminders.data.tables

import org.jetbrains.exposed.sql.Table
import org.jetbrains.exposed.sql.kotlin.datetime.timestamp

object LabelsTable : Table("labels") {
    val id = uuid("id")
    val userId = uuid("user_id").references(UsersTable.id)
    val name = varchar("name", 100)
    val color = varchar("color", 10)
    val createdAt = timestamp("created_at")
    val updatedAt = timestamp("updated_at")
    val deletedAt = timestamp("deleted_at").nullable()

    override val primaryKey = PrimaryKey(id)
}
```

## Health Check Route

### routes/HealthRoutes.kt
```kotlin
package com.cooleymd.reminders.routes

import io.ktor.http.*
import io.ktor.server.application.*
import io.ktor.server.response.*
import io.ktor.server.routing.*
import kotlinx.serialization.Serializable
import org.jetbrains.exposed.sql.transactions.transaction

@Serializable
data class HealthResponse(
    val status: String,
    val database: String,
    val version: String = "1.0.0"
)

fun Route.healthRoutes() {
    get("/health") {
        val dbStatus = try {
            transaction { exec("SELECT 1") }
            "connected"
        } catch (e: Exception) {
            "disconnected"
        }

        call.respond(
            HealthResponse(
                status = if (dbStatus == "connected") "healthy" else "unhealthy",
                database = dbStatus
            )
        )
    }

    get("/") {
        call.respondText("Reminders API v1.0.0")
    }
}
```

## Serialization Plugin

### plugins/Serialization.kt
```kotlin
package com.cooleymd.reminders.plugins

import io.ktor.serialization.kotlinx.json.*
import io.ktor.server.application.*
import io.ktor.server.plugins.contentnegotiation.*
import kotlinx.serialization.json.Json

fun Application.configureSerialization() {
    install(ContentNegotiation) {
        json(Json {
            prettyPrint = true
            isLenient = true
            ignoreUnknownKeys = true
            encodeDefaults = true
        })
    }
}
```

## Routing Plugin

### plugins/Routing.kt
```kotlin
package com.cooleymd.reminders.plugins

import com.cooleymd.reminders.routes.healthRoutes
import io.ktor.server.application.*
import io.ktor.server.plugins.callloging.*
import io.ktor.server.plugins.statuspages.*
import io.ktor.server.routing.*
import io.ktor.http.*
import io.ktor.server.response.*
import org.slf4j.event.Level

fun Application.configureRouting() {
    install(CallLogging) {
        level = Level.INFO
    }

    install(StatusPages) {
        exception<Throwable> { call, cause ->
            call.application.log.error("Unhandled exception", cause)
            call.respond(
                HttpStatusCode.InternalServerError,
                mapOf("error" to (cause.message ?: "Internal server error"))
            )
        }
    }

    routing {
        healthRoutes()
        // Auth routes will be added in F5.2
        // Reminder routes will be added in F5.3
    }
}
```

## Environment File

### .env.example
```env
DB_URL=jdbc:postgresql://localhost:5432/reminders
DB_USER=reminders
DB_PASSWORD=reminders_secret
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_ISSUER=reminders-api
JWT_AUDIENCE=reminders-app
```

## Dockerfile

```dockerfile
FROM gradle:8.5-jdk17 AS build
COPY --chown=gradle:gradle . /home/gradle/src
WORKDIR /home/gradle/src
RUN gradle buildFatJar --no-daemon

FROM openjdk:17-slim
EXPOSE 8080
RUN mkdir /app
COPY --from=build /home/gradle/src/build/libs/*-all.jar /app/reminders-backend.jar
ENTRYPOINT ["java", "-jar", "/app/reminders-backend.jar"]
```

## Verification

```bash
# Start PostgreSQL
cd backend
docker-compose up -d postgres

# Run the server locally
./gradlew run

# Test health endpoint
curl http://localhost:8080/health
# Expected: {"status":"healthy","database":"connected","version":"1.0.0"}

# Or run everything with Docker
docker-compose up --build

# Stop services
docker-compose down
```

## Files to Create
- `backend/build.gradle.kts`
- `backend/settings.gradle.kts`
- `backend/docker-compose.yml`
- `backend/Dockerfile`
- `backend/.env.example`
- `backend/src/main/resources/application.conf`
- `backend/src/main/resources/logback.xml`
- `backend/src/main/kotlin/com/cooleymd/reminders/Application.kt`
- `backend/src/main/kotlin/com/cooleymd/reminders/plugins/Database.kt`
- `backend/src/main/kotlin/com/cooleymd/reminders/plugins/Serialization.kt`
- `backend/src/main/kotlin/com/cooleymd/reminders/plugins/Routing.kt`
- `backend/src/main/kotlin/com/cooleymd/reminders/data/tables/UsersTable.kt`
- `backend/src/main/kotlin/com/cooleymd/reminders/data/tables/RemindersTable.kt`
- `backend/src/main/kotlin/com/cooleymd/reminders/data/tables/LabelsTable.kt`
- `backend/src/main/kotlin/com/cooleymd/reminders/routes/HealthRoutes.kt`
